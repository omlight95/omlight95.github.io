<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Pod控制器是管理pod的中间层，使用Pod控制器之后，只需要告诉Pod控制器，想要多少个什么样的Pod就可以了，它会创建出满足条件的Pod并确保每一个Pod资源处于用户期望的目标状态。如果Pod资源在运行中出现故障，它会基于指定策略重新编排Pod。">
<meta property="og:type" content="article">
<meta property="og:title" content="kubernetes Pod控制器">
<meta property="og:url" content="http://example.com/2022/11/02/kubernetes/8kubernetes%20Pod%E6%8E%A7%E5%88%B6%E5%99%A8/index.html">
<meta property="og:site_name" content="Omlight&#39;s Blog">
<meta property="og:description" content="Pod控制器是管理pod的中间层，使用Pod控制器之后，只需要告诉Pod控制器，想要多少个什么样的Pod就可以了，它会创建出满足条件的Pod并确保每一个Pod资源处于用户期望的目标状态。如果Pod资源在运行中出现故障，它会基于指定策略重新编排Pod。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/3551d6bca79d4f50aba848813a2460d4.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/19fef7435f1240d089f698bc81a6e353.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/42f0d0d045a440f9bc370728256c87ab.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/f27a17dd0c5c4ef88869d39ecca8c343.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/583f8f9eff4e492089fe1f98d265ff95.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/a4dffd89cb05434ea89a128e394420aa.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2a9578a3220c4e24b0738cc21a767113.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2f5daffd251d4859b61b672b026768b8.png">
<meta property="article:published_time" content="2022-11-02T03:35:28.518Z">
<meta property="article:modified_time" content="2022-11-02T07:31:58.683Z">
<meta property="article:author" content="Omlight">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/3551d6bca79d4f50aba848813a2460d4.png">

<link rel="canonical" href="http://example.com/2022/11/02/kubernetes/8kubernetes%20Pod%E6%8E%A7%E5%88%B6%E5%99%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>kubernetes Pod控制器 | Omlight's Blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?fb965384e6867949ee72c7e67224e414";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband">
	</div>
	<a target="_blank" rel="noopener" href="https://github.com/omlight95" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Omlight's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">不知乘月几人归，落月摇情满江树</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/02/kubernetes/8kubernetes%20Pod%E6%8E%A7%E5%88%B6%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Omlight">
      <meta itemprop="description" content="gopher">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Omlight's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          kubernetes Pod控制器
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-11-02 11:35:28 / 修改时间：15:31:58" itemprop="dateCreated datePublished" datetime="2022-11-02T11:35:28+08:00">2022-11-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kubernetes/" itemprop="url" rel="index"><span itemprop="name">kubernetes</span></a>
                </span>
            </span>

          
            <span id="/2022/11/02/kubernetes/8kubernetes%20Pod%E6%8E%A7%E5%88%B6%E5%99%A8/" class="post-meta-item leancloud_visitors" data-flag-title="kubernetes Pod控制器" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/11/02/kubernetes/8kubernetes%20Pod%E6%8E%A7%E5%88%B6%E5%99%A8/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/02/kubernetes/8kubernetes%20Pod%E6%8E%A7%E5%88%B6%E5%99%A8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
            <div class="post-description">Pod控制器是管理pod的中间层，使用Pod控制器之后，只需要告诉Pod控制器，想要多少个什么样的Pod就可以了，它会创建出满足条件的Pod并确保每一个Pod资源处于用户期望的目标状态。如果Pod资源在运行中出现故障，它会基于指定策略重新编排Pod。</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Pod是kubernetes的最小管理单元，在kubernetes中，按照pod的创建方式可以将其分为两类：</p>
<ul>
<li><p>自主式pod：kubernetes直接创建出来的Pod，这种pod删除后就没有了，也不会重建</p>
</li>
<li><p>控制器创建的pod：kubernetes通过控制器创建的pod，这种pod删除了之后还会自动重建</p>
</li>
</ul>
<blockquote>
<p><strong><code>什么是Pod控制器</code></strong> </p>
<p>​    Pod控制器是管理pod的中间层，使用Pod控制器之后，只需要告诉Pod控制器，想要多少个什么样的Pod就可以了，它会创建出满足条件的Pod并确保每一个Pod资源处于用户期望的目标状态。如果Pod资源在运行中出现故障，它会基于指定策略重新编排Pod。</p>
</blockquote>
<p>在kubernetes中，有很多类型的pod控制器，每种都有自己的适合的场景，常见的有下面这些：</p>
<ul>
<li><p>ReplicationController：比较原始的pod控制器，已经被废弃，由ReplicaSet替代</p>
</li>
<li><p>ReplicaSet：保证副本数量一直维持在期望值，并支持pod数量扩缩容，镜像版本升级</p>
</li>
<li><p>Deployment：通过控制ReplicaSet来控制Pod，并支持滚动升级、回退版本</p>
</li>
<li><p>Horizontal Pod Autoscaler：可以根据集群负载自动水平调整Pod的数量，实现削峰填谷</p>
</li>
<li><p>DaemonSet：在集群中的指定Node上运行且仅运行一个副本，一般用于守护进程类的任务</p>
</li>
<li><p>Job：它创建出来的pod只要完成任务就立即退出，不需要重启或重建，用于执行一次性任务</p>
</li>
<li><p>Cronjob：它创建的Pod负责周期性任务控制，不需要持续后台运行</p>
</li>
<li><p>StatefulSet：管理有状态应用</p>
</li>
</ul>
<h2 id="1-ReplicaSet-RS"><a href="#1-ReplicaSet-RS" class="headerlink" title="1. ReplicaSet(RS)"></a>1. ReplicaSet(RS)</h2><p>ReplicaSet的主要作用是<strong>保证一定数量的pod正常运行</strong>，它会持续监听这些Pod的运行状态，一旦Pod发生故障，就会重启或重建。同时它还支持对pod数量的扩缩容和镜像版本的升降级。</p>
<p><img src="https://img-blog.csdnimg.cn/3551d6bca79d4f50aba848813a2460d4.png" alt="在这里插入图片描述"><br>ReplicaSet的资源清单文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span> <span class="comment"># 版本号</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span> <span class="comment"># 类型       </span></span><br><span class="line"><span class="attr">metadata:</span> <span class="comment"># 元数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="comment"># rs名称 </span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="comment"># 所属命名空间 </span></span><br><span class="line">  <span class="attr">labels:</span> <span class="comment">#标签</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="string">rs</span></span><br><span class="line"><span class="attr">spec:</span> <span class="comment"># 详情描述</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment"># 副本数量</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment"># 选择器，通过它指定该控制器管理哪些pod</span></span><br><span class="line">    <span class="attr">matchLabels:</span>      <span class="comment"># Labels匹配规则</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">matchExpressions:</span> <span class="comment"># Expressions匹配规则</span></span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">app</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">nginx-pod</span>]&#125;</span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>在这里面，需要新了解的配置项就是<code>spec</code>下面几个选项：</p>
<ul>
<li><p>replicas：指定副本数量，其实就是当前rs创建出来的pod的数量，默认为1</p>
</li>
<li><p>selector：选择器，它的作用是建立pod控制器和pod之间的关联关系，采用的Label Selector机制，在pod模板上定义label，在控制器上定义选择器，就可以表明当前控制器能管理哪些pod了</p>
</li>
<li><p>template：模板，就是当前控制器创建pod所使用的模板板，里面其实就是前一章学过的pod的定义</p>
</li>
</ul>
<p><strong>创建ReplicaSet</strong></p>
<p>创建<code>pc-replicaset.yaml</code>文件，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span>   </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pc-replicaset</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span> </span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建rs</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl create -f pc-replicaset.yaml</span></span><br><span class="line">replicaset.apps/pc<span class="literal">-replicaset</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看rs</span></span><br><span class="line"><span class="comment"># DESIRED:期望副本数量  </span></span><br><span class="line"><span class="comment"># CURRENT:当前副本数量  </span></span><br><span class="line"><span class="comment"># READY:已经准备好提供服务的副本数量</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get rs pc-replicaset -n dev -o wide</span></span><br><span class="line">NAME          DESIRED   CURRENT READY AGE   CONTAINERS   IMAGES             SELECTOR</span><br><span class="line">pc<span class="literal">-replicaset</span> <span class="number">3</span>         <span class="number">3</span>       <span class="number">3</span>     <span class="number">22</span>s   nginx        nginx:<span class="number">1.17</span>.<span class="number">1</span>       app=nginx<span class="literal">-pod</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前控制器创建出来的pod</span></span><br><span class="line"><span class="comment"># 这里发现控制器创建出来的pod的名称是在控制器名称后面拼接了-xxxxx随机码</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get pod -n dev</span></span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">pc<span class="literal">-replicaset-6vmvt</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">54</span>s</span><br><span class="line">pc<span class="literal">-replicaset-fmb8f</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">54</span>s</span><br><span class="line">pc<span class="literal">-replicaset-snrk2</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">54</span>s</span><br></pre></td></tr></table></figure>

<p><strong>扩缩容</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑rs的副本数量，修改spec:replicas: 6即可</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl edit rs pc-replicaset -n dev</span></span><br><span class="line">replicaset.apps/pc<span class="literal">-replicaset</span> edited</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get pods -n dev</span></span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">pc<span class="literal">-replicaset-6vmvt</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">114</span>m</span><br><span class="line">pc<span class="literal">-replicaset-cftnp</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">10</span>s</span><br><span class="line">pc<span class="literal">-replicaset-fjlm6</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">10</span>s</span><br><span class="line">pc<span class="literal">-replicaset-fmb8f</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">114</span>m</span><br><span class="line">pc<span class="literal">-replicaset-s2whj</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">10</span>s</span><br><span class="line">pc<span class="literal">-replicaset-snrk2</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">114</span>m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当然也可以直接使用命令实现</span></span><br><span class="line"><span class="comment"># 使用scale命令实现扩缩容， 后面--replicas=n直接指定目标数量即可</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl scale rs pc-replicaset --replicas=2 -n dev</span></span><br><span class="line">replicaset.apps/pc<span class="literal">-replicaset</span> scaled</span><br><span class="line"></span><br><span class="line"><span class="comment"># 命令运行完毕，立即查看，发现已经有4个开始准备退出了</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get pods -n dev</span></span><br><span class="line">NAME                       READY   STATUS        RESTARTS   AGE</span><br><span class="line">pc<span class="literal">-replicaset-6vmvt</span>   <span class="number">0</span>/<span class="number">1</span>     Terminating   <span class="number">0</span>          <span class="number">118</span>m</span><br><span class="line">pc<span class="literal">-replicaset-cftnp</span>   <span class="number">0</span>/<span class="number">1</span>     Terminating   <span class="number">0</span>          <span class="number">4</span>m17s</span><br><span class="line">pc<span class="literal">-replicaset-fjlm6</span>   <span class="number">0</span>/<span class="number">1</span>     Terminating   <span class="number">0</span>          <span class="number">4</span>m17s</span><br><span class="line">pc<span class="literal">-replicaset-fmb8f</span>   <span class="number">1</span>/<span class="number">1</span>     Running       <span class="number">0</span>          <span class="number">118</span>m</span><br><span class="line">pc<span class="literal">-replicaset-s2whj</span>   <span class="number">0</span>/<span class="number">1</span>     Terminating   <span class="number">0</span>          <span class="number">4</span>m17s</span><br><span class="line">pc<span class="literal">-replicaset-snrk2</span>   <span class="number">1</span>/<span class="number">1</span>     Running       <span class="number">0</span>          <span class="number">118</span>m</span><br><span class="line"></span><br><span class="line"><span class="comment">#稍等片刻，就只剩下2个了</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get pods -n dev</span></span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">pc<span class="literal">-replicaset-fmb8f</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">119</span>m</span><br><span class="line">pc<span class="literal">-replicaset-snrk2</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">119</span>m</span><br></pre></td></tr></table></figure>

<p><strong>镜像升级</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑rs的容器镜像 - image: nginx:1.17.2</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl edit rs pc-replicaset -n dev</span></span><br><span class="line">replicaset.apps/pc<span class="literal">-replicaset</span> edited</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次查看，发现镜像版本已经变更了</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get rs -n dev -o wide</span></span><br><span class="line">NAME                DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES        ...</span><br><span class="line">pc<span class="literal">-replicaset</span>       <span class="number">2</span>        <span class="number">2</span>         <span class="number">2</span>       <span class="number">140</span>m   nginx         nginx:<span class="number">1.17</span>.<span class="number">2</span>  ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同样的道理，也可以使用命令完成这个工作</span></span><br><span class="line"><span class="comment"># kubectl set image rs rs名称 容器=镜像版本 -n namespace</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl set image rs pc-replicaset nginx=nginx:1.17.1  -n dev</span></span><br><span class="line">replicaset.apps/pc<span class="literal">-replicaset</span> image updated</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次查看，发现镜像版本已经变更了</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get rs -n dev -o wide</span></span><br><span class="line">NAME                 DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES            ...</span><br><span class="line">pc<span class="literal">-replicaset</span>        <span class="number">2</span>        <span class="number">2</span>         <span class="number">2</span>       <span class="number">145</span>m   nginx        nginx:<span class="number">1.17</span>.<span class="number">1</span> ... </span><br></pre></td></tr></table></figure>

<p><strong>删除ReplicaSet</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用kubectl delete命令会删除此RS以及它管理的Pod</span></span><br><span class="line"><span class="comment"># 在kubernetes删除RS前，会将RS的replicasclear调整为0，等待所有的Pod被删除后，在执行RS对象的删除</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl delete rs pc-replicaset -n dev</span></span><br><span class="line">replicaset.apps <span class="string">&quot;pc-replicaset&quot;</span> deleted</span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get pod -n dev -o wide</span></span><br><span class="line">No resources found <span class="keyword">in</span> dev namespace.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果希望仅仅删除RS对象（保留Pod），可以使用kubectl delete命令时添加--cascade=false选项（不推荐）。</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl delete rs pc-replicaset -n dev --cascade=false</span></span><br><span class="line">replicaset.apps <span class="string">&quot;pc-replicaset&quot;</span> deleted</span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get pods -n dev</span></span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">pc<span class="literal">-replicaset-cl82j</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">75</span>s</span><br><span class="line">pc<span class="literal">-replicaset-dslhb</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">75</span>s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以使用yaml直接删除(推荐)</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl delete -f pc-replicaset.yaml</span></span><br><span class="line">replicaset.apps <span class="string">&quot;pc-replicaset&quot;</span> deleted</span><br></pre></td></tr></table></figure>

<h2 id="2-Deployment-Deploy"><a href="#2-Deployment-Deploy" class="headerlink" title="2. Deployment(Deploy)"></a>2. Deployment(Deploy)</h2><p>为了更好的解决服务编排的问题，kubernetes在V1.2版本开始，引入了Deployment控制器。值得一提的是，这种控制器并不直接管理pod，而是通过管理ReplicaSet来简介管理Pod，即：Deployment管理ReplicaSet，ReplicaSet管理Pod。所以Deployment比ReplicaSet功能更加强大。</p>
<p><img src="https://img-blog.csdnimg.cn/19fef7435f1240d089f698bc81a6e353.png" alt="在这里插入图片描述"><br>Deployment主要功能有下面几个：</p>
<ul>
<li>支持ReplicaSet的所有功能</li>
<li>支持发布的停止、继续</li>
<li>支持滚动升级和回滚版本</li>
</ul>
<p>Deployment的资源清单文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span> <span class="comment"># 版本号</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span> <span class="comment"># 类型       </span></span><br><span class="line"><span class="attr">metadata:</span> <span class="comment"># 元数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="comment"># rs名称 </span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="comment"># 所属命名空间 </span></span><br><span class="line">  <span class="attr">labels:</span> <span class="comment">#标签</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="string">deploy</span></span><br><span class="line"><span class="attr">spec:</span> <span class="comment"># 详情描述</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment"># 副本数量</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">3</span> <span class="comment"># 保留历史版本</span></span><br><span class="line">  <span class="attr">paused:</span> <span class="literal">false</span> <span class="comment"># 暂停部署，默认是false</span></span><br><span class="line">  <span class="attr">progressDeadlineSeconds:</span> <span class="number">600</span> <span class="comment"># 部署超时时间（s），默认是600</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="comment"># 策略</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span> <span class="comment"># 滚动更新策略</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span> <span class="comment"># 滚动更新</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">30</span><span class="string">%</span> <span class="comment"># 最大额外可以存在的副本数，可以为百分比，也可以为整数</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">30</span><span class="string">%</span> <span class="comment"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment"># 选择器，通过它指定该控制器管理哪些pod</span></span><br><span class="line">    <span class="attr">matchLabels:</span>      <span class="comment"># Labels匹配规则</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">matchExpressions:</span> <span class="comment"># Expressions匹配规则</span></span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">app</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">nginx-pod</span>]&#125;</span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p><strong>创建deployment</strong></p>
<p>创建<code>pc-deployment.yaml</code>，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>      </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pc-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建deployment</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl create -f pc-deployment.yaml --record=true</span></span><br><span class="line">deployment.apps/pc<span class="literal">-deployment</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看deployment</span></span><br><span class="line"><span class="comment"># UP-TO-DATE 最新版本的pod的数量</span></span><br><span class="line"><span class="comment"># AVAILABLE  当前可用的pod的数量</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get deploy pc-deployment -n dev</span></span><br><span class="line">NAME            READY   UP<span class="literal">-TO-DATE</span>   AVAILABLE   AGE</span><br><span class="line">pc<span class="literal">-deployment</span>   <span class="number">3</span>/<span class="number">3</span>     <span class="number">3</span>            <span class="number">3</span>           <span class="number">15</span>s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看rs</span></span><br><span class="line"><span class="comment"># 发现rs的名称是在原来deployment的名字后面添加了一个10位数的随机串</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get rs -n dev</span></span><br><span class="line">NAME                       DESIRED   CURRENT   READY   AGE</span><br><span class="line">pc<span class="literal">-deployment-6696798b78</span>   <span class="number">3</span>         <span class="number">3</span>         <span class="number">3</span>       <span class="number">23</span>s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get pods -n dev</span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pc<span class="literal">-deployment-6696798b78-d2c8n</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">107</span>s</span><br><span class="line">pc<span class="literal">-deployment-6696798b78-smpvp</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">107</span>s</span><br><span class="line">pc<span class="literal">-deployment-6696798b78-wvjd8</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">107</span>s</span><br></pre></td></tr></table></figure>

<p><strong>扩缩容</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 变更副本数量为5个</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl scale deploy pc-deployment --replicas=5  -n dev</span></span><br><span class="line">deployment.apps/pc<span class="literal">-deployment</span> scaled</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看deployment</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get deploy pc-deployment -n dev</span></span><br><span class="line">NAME            READY   UP<span class="literal">-TO-DATE</span>   AVAILABLE   AGE</span><br><span class="line">pc<span class="literal">-deployment</span>   <span class="number">5</span>/<span class="number">5</span>     <span class="number">5</span>            <span class="number">5</span>           <span class="number">2</span>m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment">#  kubectl get pods -n dev</span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pc<span class="literal">-deployment-6696798b78-d2c8n</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">4</span>m19s</span><br><span class="line">pc<span class="literal">-deployment-6696798b78-jxmdq</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">94</span>s</span><br><span class="line">pc<span class="literal">-deployment-6696798b78-mktqv</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">93</span>s</span><br><span class="line">pc<span class="literal">-deployment-6696798b78-smpvp</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">4</span>m19s</span><br><span class="line">pc<span class="literal">-deployment-6696798b78-wvjd8</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">4</span>m19s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑deployment的副本数量，修改spec:replicas: 4即可</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl edit deploy pc-deployment -n dev</span></span><br><span class="line">deployment.apps/pc<span class="literal">-deployment</span> edited</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get pods -n dev</span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pc<span class="literal">-deployment-6696798b78-d2c8n</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">5</span>m23s</span><br><span class="line">pc<span class="literal">-deployment-6696798b78-jxmdq</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>m38s</span><br><span class="line">pc<span class="literal">-deployment-6696798b78-smpvp</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">5</span>m23s</span><br><span class="line">pc<span class="literal">-deployment-6696798b78-wvjd8</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">5</span>m23s</span><br></pre></td></tr></table></figure>

<p><strong>镜像更新</strong></p>
<p>deployment支持两种更新策略:<code>重建更新</code>和<code>滚动更新</code>,可以通过<code>strategy</code>指定策略类型,支持两个属性:</p>
<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">strategy：指定新的Pod替换旧的Pod的策略， 支持两个属性：</span><br><span class="line">  type：指定策略类型，支持两种策略</span><br><span class="line"><span class="code">    Recreate：在创建出新的Pod之前会先杀掉所有已存在的Pod</span></span><br><span class="line"><span class="code">    RollingUpdate：滚动更新，就是杀死一部分，就启动一部分，在更新过程中，存在两个版本Pod</span></span><br><span class="line"><span class="code">  rollingUpdate：当type为RollingUpdate时生效，用于为RollingUpdate设置参数，支持两个属性：</span></span><br><span class="line"><span class="code">    maxUnavailable：用来指定在升级过程中不可用Pod的最大数量，默认为25%。</span></span><br><span class="line"><span class="code">    maxSurge： 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%。</span></span><br></pre></td></tr></table></figure>

<p>重建更新</p>
<ol>
<li><p>编辑pc-deployment.yaml,在spec节点下添加更新策略</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="comment"># 策略</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span> <span class="comment"># 重建更新</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建deploy进行验证</p>
 <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 变更镜像</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl set image deployment pc-deployment nginx=nginx:1.17.2 -n dev</span></span><br><span class="line">deployment.apps/pc<span class="literal">-deployment</span> image updated</span><br><span class="line"></span><br><span class="line"><span class="comment"># 观察升级过程</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment">#  kubectl get pods -n dev -w</span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pc<span class="literal">-deployment-5d89bdfbf9-65qcw</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">31</span>s</span><br><span class="line">pc<span class="literal">-deployment-5d89bdfbf9-w5nzv</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">31</span>s</span><br><span class="line">pc<span class="literal">-deployment-5d89bdfbf9-xpt7w</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">31</span>s</span><br><span class="line"></span><br><span class="line">pc<span class="literal">-deployment-5d89bdfbf9-xpt7w</span>   <span class="number">1</span>/<span class="number">1</span>     Terminating   <span class="number">0</span>          <span class="number">41</span>s</span><br><span class="line">pc<span class="literal">-deployment-5d89bdfbf9-65qcw</span>   <span class="number">1</span>/<span class="number">1</span>     Terminating   <span class="number">0</span>          <span class="number">41</span>s</span><br><span class="line">pc<span class="literal">-deployment-5d89bdfbf9-w5nzv</span>   <span class="number">1</span>/<span class="number">1</span>     Terminating   <span class="number">0</span>          <span class="number">41</span>s</span><br><span class="line"></span><br><span class="line">pc<span class="literal">-deployment-675d469f8b-grn8z</span>   <span class="number">0</span>/<span class="number">1</span>     Pending       <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-deployment-675d469f8b-hbl4v</span>   <span class="number">0</span>/<span class="number">1</span>     Pending       <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-deployment-675d469f8b-67nz2</span>   <span class="number">0</span>/<span class="number">1</span>     Pending       <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line">pc<span class="literal">-deployment-675d469f8b-grn8z</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-deployment-675d469f8b-hbl4v</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-deployment-675d469f8b-67nz2</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line">pc<span class="literal">-deployment-675d469f8b-grn8z</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">1</span>s</span><br><span class="line">pc<span class="literal">-deployment-675d469f8b-67nz2</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">1</span>s</span><br><span class="line">pc<span class="literal">-deployment-675d469f8b-hbl4v</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">2</span>s</span><br></pre></td></tr></table></figure></li>
</ol>
<p>滚动更新</p>
<ol>
<li><p>编辑<code>pc-deployment.yaml</code>，在spec节点下添加更新策略</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="comment"># 策略</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span> <span class="comment"># 滚动更新策略</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">25</span><span class="string">%</span> </span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建deploy进行验证</p>
</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 变更镜像</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl set image deployment pc-deployment nginx=nginx:1.17.3 -n dev</span></span><br><span class="line">deployment.apps/pc<span class="literal">-deployment</span> image updated</span><br><span class="line"></span><br><span class="line"><span class="comment"># 观察升级过程</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get pods -n dev -w</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pc<span class="literal">-deployment-c848d767-8rbzt</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">31</span>m</span><br><span class="line">pc<span class="literal">-deployment-c848d767-h4p68</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">31</span>m</span><br><span class="line">pc<span class="literal">-deployment-c848d767-hlmz4</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">31</span>m</span><br><span class="line">pc<span class="literal">-deployment-c848d767-rrqcn</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">31</span>m</span><br><span class="line"></span><br><span class="line">pc<span class="literal">-deployment-966bf7f44-226rx</span>   <span class="number">0</span>/<span class="number">1</span>     Pending             <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-deployment-966bf7f44-226rx</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-deployment-966bf7f44-226rx</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">1</span>s</span><br><span class="line">pc<span class="literal">-deployment-c848d767-h4p68</span>    <span class="number">0</span>/<span class="number">1</span>     Terminating         <span class="number">0</span>          <span class="number">34</span>m</span><br><span class="line"></span><br><span class="line">pc<span class="literal">-deployment-966bf7f44-cnd44</span>   <span class="number">0</span>/<span class="number">1</span>     Pending             <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-deployment-966bf7f44-cnd44</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-deployment-966bf7f44-cnd44</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">2</span>s</span><br><span class="line">pc<span class="literal">-deployment-c848d767-hlmz4</span>    <span class="number">0</span>/<span class="number">1</span>     Terminating         <span class="number">0</span>          <span class="number">34</span>m</span><br><span class="line"></span><br><span class="line">pc<span class="literal">-deployment-966bf7f44-px48p</span>   <span class="number">0</span>/<span class="number">1</span>     Pending             <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-deployment-966bf7f44-px48p</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-deployment-966bf7f44-px48p</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-deployment-c848d767-8rbzt</span>    <span class="number">0</span>/<span class="number">1</span>     Terminating         <span class="number">0</span>          <span class="number">34</span>m</span><br><span class="line"></span><br><span class="line">pc<span class="literal">-deployment-966bf7f44-dkmqp</span>   <span class="number">0</span>/<span class="number">1</span>     Pending             <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-deployment-966bf7f44-dkmqp</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-deployment-966bf7f44-dkmqp</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">2</span>s</span><br><span class="line">pc<span class="literal">-deployment-c848d767-rrqcn</span>    <span class="number">0</span>/<span class="number">1</span>     Terminating         <span class="number">0</span>          <span class="number">34</span>m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 至此，新版本的pod创建完毕，就版本的pod销毁完毕</span></span><br><span class="line"><span class="comment"># 中间过程是滚动进行的，也就是边销毁边创建</span></span><br></pre></td></tr></table></figure>

<p>滚动更新的过程：</p>
<p><img src="https://img-blog.csdnimg.cn/42f0d0d045a440f9bc370728256c87ab.png" alt="在这里插入图片描述"><br>镜像更新中rs的变化:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看rs,发现原来的rs的依旧存在，只是pod数量变为了0，而后又新产生了一个rs，pod数量为4</span></span><br><span class="line"><span class="comment"># 其实这就是deployment能够进行版本回退的奥妙所在，后面会详细解释</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get rs -n dev</span></span><br><span class="line">NAME                       DESIRED   CURRENT   READY   AGE</span><br><span class="line">pc<span class="literal">-deployment-6696798b78</span>   <span class="number">0</span>         <span class="number">0</span>         <span class="number">0</span>       <span class="number">7</span>m37s</span><br><span class="line">pc<span class="literal">-deployment-6696798b11</span>   <span class="number">0</span>         <span class="number">0</span>         <span class="number">0</span>       <span class="number">5</span>m37s</span><br><span class="line">pc<span class="literal">-deployment-c848d76789</span>   <span class="number">4</span>         <span class="number">4</span>         <span class="number">4</span>       <span class="number">72</span>s</span><br></pre></td></tr></table></figure>

<p><strong>版本回退</strong></p>
<p>deployment支持版本升级过程中的暂停、继续功能以及版本回退等诸多功能，下面具体来看.</p>
<p>kubectl rollout： 版本升级相关功能，支持下面的选项：</p>
<ul>
<li><p>status       显示当前升级状态</p>
</li>
<li><p>history     显示 升级历史记录</p>
</li>
<li><p>pause       暂停版本升级过程</p>
</li>
<li><p>resume    继续已经暂停的版本升级过程</p>
</li>
<li><p>restart      重启版本升级过程</p>
</li>
<li><p>undo        回滚到上一级版本（可以使用–to-revision回滚到指定版本）</p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">deployment支持版本升级过程中的暂停、继续功能以及版本回退等诸多功能，下面具体来看.</span><br><span class="line"></span><br><span class="line">kubectl rollout： 版本升级相关功能，支持下面的选项：</span><br><span class="line"></span><br><span class="line">- status       显示当前升级状态</span><br><span class="line">- <span class="built_in">history</span>     显示 升级历史记录</span><br><span class="line"></span><br><span class="line">- pause       暂停版本升级过程</span><br><span class="line">- resume    继续已经暂停的版本升级过程</span><br><span class="line">- restart      重启版本升级过程</span><br><span class="line">- undo        回滚到上一级版本（可以使用<span class="literal">--to-revision</span>回滚到指定版本）</span><br></pre></td></tr></table></figure>

<p><strong>金丝雀发布</strong></p>
<p>Deployment控制器支持控制更新过程中的控制，如“暂停(pause)”或“继续(resume)”更新操作。</p>
<p>​    比如有一批新的Pod资源创建完成后立即暂停更新过程，此时，仅存在一部分新版本的应用，主体部分还是旧的版本。然后，再筛选一小部分的用户请求路由到新版本的Pod应用，继续观察能否稳定地按期望的方式运行。确定没问题之后再继续完成余下的Pod资源滚动更新，否则立即回滚更新操作。这就是所谓的金丝雀发布。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新deployment的版本，并配置暂停deployment</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment">#  kubectl set image deploy pc-deployment nginx=nginx:1.17.4 -n dev &amp;&amp; kubectl rollout pause deployment pc-deployment  -n dev</span></span><br><span class="line">deployment.apps/pc<span class="literal">-deployment</span> image updated</span><br><span class="line">deployment.apps/pc<span class="literal">-deployment</span> paused</span><br><span class="line"></span><br><span class="line"><span class="comment">#观察更新状态</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl rollout status deploy pc-deployment -n dev　</span></span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;pc-deployment&quot;</span> rollout to finish: <span class="number">2</span> out of <span class="number">4</span> new replicas have been updated...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控更新的过程，可以看到已经新增了一个资源，但是并未按照预期的状态去删除一个旧的资源，就是因为使用了pause暂停命令</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get rs -n dev -o wide</span></span><br><span class="line">NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         </span><br><span class="line">pc<span class="literal">-deployment-5d89bdfbf9</span>   <span class="number">3</span>         <span class="number">3</span>         <span class="number">3</span>       <span class="number">19</span>m     nginx        nginx:<span class="number">1.17</span>.<span class="number">1</span>   </span><br><span class="line">pc<span class="literal">-deployment-675d469f8b</span>   <span class="number">0</span>         <span class="number">0</span>         <span class="number">0</span>       <span class="number">14</span>m     nginx        nginx:<span class="number">1.17</span>.<span class="number">2</span>   </span><br><span class="line">pc<span class="literal">-deployment-6c9f56fcfb</span>   <span class="number">2</span>         <span class="number">2</span>         <span class="number">2</span>       <span class="number">3</span>m16s   nginx        nginx:<span class="number">1.17</span>.<span class="number">4</span>   </span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get pods -n dev</span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pc<span class="literal">-deployment-5d89bdfbf9-rj8sq</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7</span>m33s</span><br><span class="line">pc<span class="literal">-deployment-5d89bdfbf9-ttwgg</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7</span>m35s</span><br><span class="line">pc<span class="literal">-deployment-5d89bdfbf9-v4wvc</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">7</span>m34s</span><br><span class="line">pc<span class="literal">-deployment-6c9f56fcfb-996rt</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>m31s</span><br><span class="line">pc<span class="literal">-deployment-6c9f56fcfb-j2gtj</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>m31s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保更新的pod没问题了，继续更新</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl rollout resume deploy pc-deployment -n dev</span></span><br><span class="line">deployment.apps/pc<span class="literal">-deployment</span> resumed</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看最后的更新情况</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get rs -n dev -o wide</span></span><br><span class="line">NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         </span><br><span class="line">pc<span class="literal">-deployment-5d89bdfbf9</span>   <span class="number">0</span>         <span class="number">0</span>         <span class="number">0</span>       <span class="number">21</span>m     nginx        nginx:<span class="number">1.17</span>.<span class="number">1</span>   </span><br><span class="line">pc<span class="literal">-deployment-675d469f8b</span>   <span class="number">0</span>         <span class="number">0</span>         <span class="number">0</span>       <span class="number">16</span>m     nginx        nginx:<span class="number">1.17</span>.<span class="number">2</span>   </span><br><span class="line">pc<span class="literal">-deployment-6c9f56fcfb</span>   <span class="number">4</span>         <span class="number">4</span>         <span class="number">4</span>       <span class="number">5</span>m11s   nginx        nginx:<span class="number">1.17</span>.<span class="number">4</span>   </span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get pods -n dev</span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pc<span class="literal">-deployment-6c9f56fcfb-7bfwh</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">37</span>s</span><br><span class="line">pc<span class="literal">-deployment-6c9f56fcfb-996rt</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">5</span>m27s</span><br><span class="line">pc<span class="literal">-deployment-6c9f56fcfb-j2gtj</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">5</span>m27s</span><br><span class="line">pc<span class="literal">-deployment-6c9f56fcfb-rf84v</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">37</span>s</span><br></pre></td></tr></table></figure>


<p><strong>删除Deployment</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除deployment，其下的rs和pod也将被删除</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl delete -f pc-deployment.yaml</span></span><br><span class="line">deployment.apps <span class="string">&quot;pc-deployment&quot;</span> deleted</span><br></pre></td></tr></table></figure>

<h2 id="3-Horizontal-Pod-Autoscaler-HPA"><a href="#3-Horizontal-Pod-Autoscaler-HPA" class="headerlink" title="3. Horizontal Pod Autoscaler(HPA)"></a>3. Horizontal Pod Autoscaler(HPA)</h2><p>在前面的内容中，我们已经可以实现通过手工执行<code>kubectl scale</code>命令实现Pod扩容或缩容，但是这显然不符合Kubernetes的定位目标–自动化、智能化。 Kubernetes期望可以实现通过监测Pod的使用情况，实现pod数量的自动调整，于是就产生了Horizontal Pod Autoscaler（HPA）这种控制器。</p>
<p>​    HPA可以获取每个Pod利用率，然后和HPA中定义的指标进行对比，同时计算出需要伸缩的具体值，最后实现Pod的数量的调整。其实HPA与之前的Deployment一样，也属于一种Kubernetes资源对象，它通过追踪分析RC控制的所有目标Pod的负载变化情况，来确定是否需要针对性地调整目标Pod的副本数，这是HPA的实现原理。</p>
<p><img src="https://img-blog.csdnimg.cn/f27a17dd0c5c4ef88869d39ecca8c343.png" alt="在这里插入图片描述"></p>
<p>接下来，我们来做一个实验</p>
<p><strong>1 安装metrics-server</strong></p>
<p>metrics-server可以用来收集集群中的资源使用情况</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装git</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># yum install git -y</span></span><br><span class="line"><span class="comment"># 获取metrics-server, 注意使用的版本</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># git clone -b v0.3.6 https://github.com/kubernetes-incubator/metrics-server</span></span><br><span class="line"><span class="comment"># 修改deployment, 注意修改的是镜像和初始化参数</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># cd /root/metrics-server/deploy/1.8+/</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="number">1.8</span>+]<span class="comment"># vim metrics-server-deployment.yaml</span></span><br><span class="line">按图中添加下面选项</span><br><span class="line">hostNetwork: true</span><br><span class="line">image: registry.cn<span class="literal">-hangzhou</span>.aliyuncs.com/google_containers/metrics<span class="literal">-server-amd64</span>:v0.<span class="number">3.6</span></span><br><span class="line">args:</span><br><span class="line">- <span class="literal">--kubelet-insecure-tls</span></span><br><span class="line">- <span class="literal">--kubelet-preferred-address-types</span>=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/583f8f9eff4e492089fe1f98d265ff95.png" alt="在这里插入图片描述"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装metrics-server</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="number">1.8</span>+]<span class="comment"># kubectl apply -f ./</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod运行情况</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="number">1.8</span>+]<span class="comment"># kubectl get pod -n kube-system</span></span><br><span class="line">metrics<span class="literal">-server-6b976979db-2xwbj</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">90</span>s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用kubectl top node 查看资源使用情况</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="number">1.8</span>+]<span class="comment"># kubectl top node</span></span><br><span class="line">NAME     CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span><br><span class="line">master   <span class="number">98</span>m          <span class="number">4</span>%     <span class="number">1067</span><span class="built_in">Mi</span>          <span class="number">62</span>%</span><br><span class="line">node1    <span class="number">27</span>m          <span class="number">1</span>%     <span class="number">727</span><span class="built_in">Mi</span>           <span class="number">42</span>%</span><br><span class="line">node2    <span class="number">34</span>m          <span class="number">1</span>%     <span class="number">800</span><span class="built_in">Mi</span>           <span class="number">46</span>%</span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="number">1.8</span>+]<span class="comment"># kubectl top pod -n kube-system</span></span><br><span class="line">NAME                              CPU(cores)   MEMORY(bytes)</span><br><span class="line">coredns<span class="literal">-6955765f44-7ptsb</span>          <span class="number">3</span>m           <span class="number">9</span><span class="built_in">Mi</span></span><br><span class="line">coredns<span class="literal">-6955765f44-vcwr5</span>          <span class="number">3</span>m           <span class="number">8</span><span class="built_in">Mi</span></span><br><span class="line">etcd<span class="literal">-master</span>                       <span class="number">14</span>m          <span class="number">145</span><span class="built_in">Mi</span></span><br><span class="line">...</span><br><span class="line"><span class="comment"># 至此,metrics-server安装完成</span></span><br></pre></td></tr></table></figure>

<p><strong>2 准备deployment和servie</strong></p>
<p>为了操作简单,直接使用命令</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建deployment </span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="number">1.8</span>+]<span class="comment"># kubectl run nginx --image=nginx:latest --requests=cpu=100m -n dev</span></span><br><span class="line"><span class="comment"># 创建service</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="number">1.8</span>+]<span class="comment"># kubectl expose deployment nginx --type=NodePort --port=80 -n dev</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="number">1.8</span>+]<span class="comment"># kubectl get deployment,pod,svc -n dev</span></span><br><span class="line">NAME                    READY   UP<span class="literal">-TO-DATE</span>   AVAILABLE   AGE</span><br><span class="line">deployment.apps/nginx   <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">47</span>s</span><br><span class="line"></span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nginx<span class="literal">-7df9756ccc-bh8dr</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">47</span>s</span><br><span class="line"></span><br><span class="line">NAME            <span class="built_in">TYPE</span>       CLUSTER<span class="literal">-IP</span>      EXTERNAL<span class="literal">-IP</span>   PORT(S)        AGE</span><br><span class="line">service/nginx   NodePort   <span class="number">10.109</span>.<span class="number">57.248</span>   &lt;none&gt;        <span class="number">80</span>:<span class="number">31136</span>/TCP   <span class="number">35</span>s</span><br></pre></td></tr></table></figure>

<p><strong>3 部署HPA</strong></p>
<p>创建<code>pc-hpa.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pc-hpa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span>  <span class="comment">#最小pod数量</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span> <span class="comment">#最大pod数量</span></span><br><span class="line">  <span class="attr">targetCPUUtilizationPercentage:</span> <span class="number">3</span> <span class="comment"># CPU使用率指标</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span>   <span class="comment"># 指定要控制的nginx信息</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span>  </span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span>  </span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建hpa</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="number">1.8</span>+]<span class="comment"># kubectl create -f pc-hpa.yaml</span></span><br><span class="line">horizontalpodautoscaler.autoscaling/pc<span class="literal">-hpa</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看hpa</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="number">1.8</span>+]<span class="comment"># kubectl get hpa -n dev</span></span><br><span class="line">NAME     REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">pc<span class="literal">-hpa</span>   Deployment/nginx   <span class="number">0</span>%/<span class="number">3</span>%     <span class="number">1</span>         <span class="number">10</span>        <span class="number">1</span>          <span class="number">62</span>s</span><br></pre></td></tr></table></figure>

<p><strong>4 测试</strong></p>
<p>使用压测工具对service地址<code>192.168.109.100:31136</code>进行压测，然后通过控制台查看hpa和pod的变化</p>
<p><code>hpa变化</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get hpa -n dev -w</span></span><br><span class="line">NAME     REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">pc<span class="literal">-hpa</span>   Deployment/nginx   <span class="number">0</span>%/<span class="number">3</span>%     <span class="number">1</span>         <span class="number">10</span>        <span class="number">1</span>          <span class="number">4</span>m11s</span><br><span class="line">pc<span class="literal">-hpa</span>   Deployment/nginx   <span class="number">0</span>%/<span class="number">3</span>%     <span class="number">1</span>         <span class="number">10</span>        <span class="number">1</span>          <span class="number">5</span>m19s</span><br><span class="line">pc<span class="literal">-hpa</span>   Deployment/nginx   <span class="number">22</span>%/<span class="number">3</span>%    <span class="number">1</span>         <span class="number">10</span>        <span class="number">1</span>          <span class="number">6</span>m50s</span><br><span class="line">pc<span class="literal">-hpa</span>   Deployment/nginx   <span class="number">22</span>%/<span class="number">3</span>%    <span class="number">1</span>         <span class="number">10</span>        <span class="number">4</span>          <span class="number">7</span>m5s</span><br><span class="line">pc<span class="literal">-hpa</span>   Deployment/nginx   <span class="number">22</span>%/<span class="number">3</span>%    <span class="number">1</span>         <span class="number">10</span>        <span class="number">8</span>          <span class="number">7</span>m21s</span><br><span class="line">pc<span class="literal">-hpa</span>   Deployment/nginx   <span class="number">6</span>%/<span class="number">3</span>%     <span class="number">1</span>         <span class="number">10</span>        <span class="number">8</span>          <span class="number">7</span>m51s</span><br><span class="line">pc<span class="literal">-hpa</span>   Deployment/nginx   <span class="number">0</span>%/<span class="number">3</span>%     <span class="number">1</span>         <span class="number">10</span>        <span class="number">8</span>          <span class="number">9</span>m6s</span><br><span class="line">pc<span class="literal">-hpa</span>   Deployment/nginx   <span class="number">0</span>%/<span class="number">3</span>%     <span class="number">1</span>         <span class="number">10</span>        <span class="number">8</span>          <span class="number">13</span>m</span><br><span class="line">pc<span class="literal">-hpa</span>   Deployment/nginx   <span class="number">0</span>%/<span class="number">3</span>%     <span class="number">1</span>         <span class="number">10</span>        <span class="number">1</span>          <span class="number">14</span>m</span><br></pre></td></tr></table></figure>

<p><code>deployment变化</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get deployment -n dev -w</span></span><br><span class="line">NAME    READY   UP<span class="literal">-TO-DATE</span>   AVAILABLE   AGE</span><br><span class="line">nginx   <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">11</span>m</span><br><span class="line">nginx   <span class="number">1</span>/<span class="number">4</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">13</span>m</span><br><span class="line">nginx   <span class="number">1</span>/<span class="number">4</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">13</span>m</span><br><span class="line">nginx   <span class="number">1</span>/<span class="number">4</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">13</span>m</span><br><span class="line">nginx   <span class="number">1</span>/<span class="number">4</span>     <span class="number">4</span>            <span class="number">1</span>           <span class="number">13</span>m</span><br><span class="line">nginx   <span class="number">1</span>/<span class="number">8</span>     <span class="number">4</span>            <span class="number">1</span>           <span class="number">14</span>m</span><br><span class="line">nginx   <span class="number">1</span>/<span class="number">8</span>     <span class="number">4</span>            <span class="number">1</span>           <span class="number">14</span>m</span><br><span class="line">nginx   <span class="number">1</span>/<span class="number">8</span>     <span class="number">4</span>            <span class="number">1</span>           <span class="number">14</span>m</span><br><span class="line">nginx   <span class="number">1</span>/<span class="number">8</span>     <span class="number">8</span>            <span class="number">1</span>           <span class="number">14</span>m</span><br><span class="line">nginx   <span class="number">2</span>/<span class="number">8</span>     <span class="number">8</span>            <span class="number">2</span>           <span class="number">14</span>m</span><br><span class="line">nginx   <span class="number">3</span>/<span class="number">8</span>     <span class="number">8</span>            <span class="number">3</span>           <span class="number">14</span>m</span><br><span class="line">nginx   <span class="number">4</span>/<span class="number">8</span>     <span class="number">8</span>            <span class="number">4</span>           <span class="number">14</span>m</span><br><span class="line">nginx   <span class="number">5</span>/<span class="number">8</span>     <span class="number">8</span>            <span class="number">5</span>           <span class="number">14</span>m</span><br><span class="line">nginx   <span class="number">6</span>/<span class="number">8</span>     <span class="number">8</span>            <span class="number">6</span>           <span class="number">14</span>m</span><br><span class="line">nginx   <span class="number">7</span>/<span class="number">8</span>     <span class="number">8</span>            <span class="number">7</span>           <span class="number">14</span>m</span><br><span class="line">nginx   <span class="number">8</span>/<span class="number">8</span>     <span class="number">8</span>            <span class="number">8</span>           <span class="number">15</span>m</span><br><span class="line">nginx   <span class="number">8</span>/<span class="number">1</span>     <span class="number">8</span>            <span class="number">8</span>           <span class="number">20</span>m</span><br><span class="line">nginx   <span class="number">8</span>/<span class="number">1</span>     <span class="number">8</span>            <span class="number">8</span>           <span class="number">20</span>m</span><br><span class="line">nginx   <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">20</span>m</span><br></pre></td></tr></table></figure>

<p><code>pod变化</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get pods -n dev -w</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx<span class="literal">-7df9756ccc-bh8dr</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">11</span>m</span><br><span class="line">nginx<span class="literal">-7df9756ccc-cpgrv</span>   <span class="number">0</span>/<span class="number">1</span>     Pending   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-8zhwk</span>   <span class="number">0</span>/<span class="number">1</span>     Pending   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-rr9bn</span>   <span class="number">0</span>/<span class="number">1</span>     Pending   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-cpgrv</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-8zhwk</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-rr9bn</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-m9gsj</span>   <span class="number">0</span>/<span class="number">1</span>     Pending             <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-g56qb</span>   <span class="number">0</span>/<span class="number">1</span>     Pending             <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-sl9c6</span>   <span class="number">0</span>/<span class="number">1</span>     Pending             <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-fgst7</span>   <span class="number">0</span>/<span class="number">1</span>     Pending             <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-g56qb</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-m9gsj</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-sl9c6</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-fgst7</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-8zhwk</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">19</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-rr9bn</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">30</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-m9gsj</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">21</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-cpgrv</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">47</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-sl9c6</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">33</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-g56qb</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">48</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-fgst7</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">66</span>s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-fgst7</span>   <span class="number">1</span>/<span class="number">1</span>     Terminating         <span class="number">0</span>          <span class="number">6</span>m50s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-8zhwk</span>   <span class="number">1</span>/<span class="number">1</span>     Terminating         <span class="number">0</span>          <span class="number">7</span>m5s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-cpgrv</span>   <span class="number">1</span>/<span class="number">1</span>     Terminating         <span class="number">0</span>          <span class="number">7</span>m5s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-g56qb</span>   <span class="number">1</span>/<span class="number">1</span>     Terminating         <span class="number">0</span>          <span class="number">6</span>m50s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-rr9bn</span>   <span class="number">1</span>/<span class="number">1</span>     Terminating         <span class="number">0</span>          <span class="number">7</span>m5s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-m9gsj</span>   <span class="number">1</span>/<span class="number">1</span>     Terminating         <span class="number">0</span>          <span class="number">6</span>m50s</span><br><span class="line">nginx<span class="literal">-7df9756ccc-sl9c6</span>   <span class="number">1</span>/<span class="number">1</span>     Terminating         <span class="number">0</span>          <span class="number">6</span>m50s</span><br></pre></td></tr></table></figure>


<h2 id="4-DaemonSet-DS"><a href="#4-DaemonSet-DS" class="headerlink" title="4. DaemonSet(DS)"></a>4. DaemonSet(DS)</h2><p>DaemonSet类型的控制器可以保证在集群中的每一台（或指定）节点上都运行一个副本。一般适用于日志收集、节点监控等场景。也就是说，如果一个Pod提供的功能是节点级别的（每个节点都需要且只需要一个），那么这类Pod就适合使用DaemonSet类型的控制器创建。</p>
<p><img src="https://img-blog.csdnimg.cn/a4dffd89cb05434ea89a128e394420aa.png" alt="在这里插入图片描述"><br>DaemonSet控制器的特点：</p>
<ul>
<li>每当向集群中添加一个节点时，指定的 Pod 副本也将添加到该节点上</li>
<li>当节点从集群中移除时，Pod 也就被垃圾回收了</li>
</ul>
<p>下面先来看下DaemonSet的资源清单文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span> <span class="comment"># 版本号</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span> <span class="comment"># 类型       </span></span><br><span class="line"><span class="attr">metadata:</span> <span class="comment"># 元数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="comment"># rs名称 </span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="comment"># 所属命名空间 </span></span><br><span class="line">  <span class="attr">labels:</span> <span class="comment">#标签</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="string">daemonset</span></span><br><span class="line"><span class="attr">spec:</span> <span class="comment"># 详情描述</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">3</span> <span class="comment"># 保留历史版本</span></span><br><span class="line">  <span class="attr">updateStrategy:</span> <span class="comment"># 更新策略</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span> <span class="comment"># 滚动更新策略</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span> <span class="comment"># 滚动更新</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span> <span class="comment"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment"># 选择器，通过它指定该控制器管理哪些pod</span></span><br><span class="line">    <span class="attr">matchLabels:</span>      <span class="comment"># Labels匹配规则</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">matchExpressions:</span> <span class="comment"># Expressions匹配规则</span></span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">app</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">nginx-pod</span>]&#125;</span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>创建<code>pc-daemonset.yaml</code>，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span>      </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pc-daemonset</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建daemonset</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl create -f  pc-daemonset.yaml</span></span><br><span class="line">daemonset.apps/pc<span class="literal">-daemonset</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看daemonset</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment">#  kubectl get ds -n dev -o wide</span></span><br><span class="line">NAME        DESIRED  CURRENT  READY  UP<span class="literal">-TO-DATE</span>  AVAILABLE   AGE   CONTAINERS   IMAGES         </span><br><span class="line">pc<span class="literal">-daemonset</span>   <span class="number">2</span>        <span class="number">2</span>        <span class="number">2</span>      <span class="number">2</span>           <span class="number">2</span>        <span class="number">24</span>s   nginx        nginx:<span class="number">1.17</span>.<span class="number">1</span>   </span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod,发现在每个Node上都运行一个pod</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment">#  kubectl get pods -n dev -o wide</span></span><br><span class="line">NAME                 READY   STATUS    RESTARTS   AGE   IP            NODE    </span><br><span class="line">pc<span class="literal">-daemonset-9bck8</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">37</span>s   <span class="number">10.244</span>.<span class="number">1.43</span>   node1     </span><br><span class="line">pc<span class="literal">-daemonset-k224w</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">37</span>s   <span class="number">10.244</span>.<span class="number">2.74</span>   node2      </span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除daemonset</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl delete -f pc-daemonset.yaml</span></span><br><span class="line">daemonset.apps <span class="string">&quot;pc-daemonset&quot;</span> deleted</span><br></pre></td></tr></table></figure>

<h2 id="5-Job"><a href="#5-Job" class="headerlink" title="5. Job"></a>5. Job</h2><p>Job，主要用于负责批量处理(一次要处理指定数量任务)短暂的一次性(每个任务仅运行一次就结束)任务。Job特点如下：</p>
<ul>
<li>当Job创建的pod执行成功结束时，Job将记录成功结束的pod数量</li>
<li>当成功结束的pod达到指定的数量时，Job将完成执行</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/2a9578a3220c4e24b0738cc21a767113.png" alt="在这里插入图片描述"><br>Job的资源清单文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span> <span class="comment"># 版本号</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span> <span class="comment"># 类型       </span></span><br><span class="line"><span class="attr">metadata:</span> <span class="comment"># 元数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="comment"># rs名称 </span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="comment"># 所属命名空间 </span></span><br><span class="line">  <span class="attr">labels:</span> <span class="comment">#标签</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="string">job</span></span><br><span class="line"><span class="attr">spec:</span> <span class="comment"># 详情描述</span></span><br><span class="line">  <span class="attr">completions:</span> <span class="number">1</span> <span class="comment"># 指定job需要成功运行Pods的次数。默认值: 1</span></span><br><span class="line">  <span class="attr">parallelism:</span> <span class="number">1</span> <span class="comment"># 指定job在任一时刻应该并发运行Pods的数量。默认值: 1</span></span><br><span class="line">  <span class="attr">activeDeadlineSeconds:</span> <span class="number">30</span> <span class="comment"># 指定job可运行的时间期限，超过时间还未结束，系统将会尝试进行终止。</span></span><br><span class="line">  <span class="attr">backoffLimit:</span> <span class="number">6</span> <span class="comment"># 指定job失败后进行重试的次数。默认是6</span></span><br><span class="line">  <span class="attr">manualSelector:</span> <span class="literal">true</span> <span class="comment"># 是否可以使用selector选择器选择pod，默认是false</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment"># 选择器，通过它指定该控制器管理哪些pod</span></span><br><span class="line">    <span class="attr">matchLabels:</span>      <span class="comment"># Labels匹配规则</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">counter-pod</span></span><br><span class="line">    <span class="attr">matchExpressions:</span> <span class="comment"># Expressions匹配规则</span></span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">app</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">counter-pod</span>]&#125;</span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">counter-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span> <span class="comment"># 重启策略只能设置为Never或者OnFailure</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">counter</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 2;done&quot;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">关于重启策略设置的说明：</span><br><span class="line"><span class="code">    如果指定为OnFailure，则job会在pod出现故障时重启容器，而不是创建pod，failed次数不变</span></span><br><span class="line"><span class="code">    如果指定为Never，则job会在pod出现故障时创建新的pod，并且故障pod不会消失，也不会重启，failed次数加1</span></span><br><span class="line"><span class="code">    如果指定为Always的话，就意味着一直重启，意味着job任务会重复去执行了，当然不对，所以不能设置为Always</span></span><br></pre></td></tr></table></figure>

<p>创建<code>pc-job.yaml</code>，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span>      </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pc-job</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">manualSelector:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">counter-pod</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">counter-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">counter</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&quot;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建job</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl create -f pc-job.yaml</span></span><br><span class="line">job.batch/pc<span class="literal">-job</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看job</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get job -n dev -o wide  -w</span></span><br><span class="line">NAME     COMPLETIONS   DURATION   AGE   CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">pc<span class="literal">-job</span>   <span class="number">0</span>/<span class="number">1</span>           <span class="number">21</span>s        <span class="number">21</span>s   counter      busybox:<span class="number">1.30</span>   app=counter<span class="literal">-pod</span></span><br><span class="line">pc<span class="literal">-job</span>   <span class="number">1</span>/<span class="number">1</span>           <span class="number">31</span>s        <span class="number">79</span>s   counter      busybox:<span class="number">1.30</span>   app=counter<span class="literal">-pod</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过观察pod状态可以看到，pod在运行完毕任务后，就会变成Completed状态</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get pods -n dev -w</span></span><br><span class="line">NAME           READY   STATUS     RESTARTS      AGE</span><br><span class="line">pc<span class="literal">-job-rxg96</span>   <span class="number">1</span>/<span class="number">1</span>     Running     <span class="number">0</span>            <span class="number">29</span>s</span><br><span class="line">pc<span class="literal">-job-rxg96</span>   <span class="number">0</span>/<span class="number">1</span>     Completed   <span class="number">0</span>            <span class="number">33</span>s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接下来，调整下pod运行的总数量和并行数量 即：在spec下设置下面两个选项</span></span><br><span class="line"><span class="comment">#  completions: 6 # 指定job需要成功运行Pods的次数为6</span></span><br><span class="line"><span class="comment">#  parallelism: 3 # 指定job并发运行Pods的数量为3</span></span><br><span class="line"><span class="comment">#  然后重新运行job，观察效果，此时会发现，job会每次运行3个pod，总共执行了6个pod</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get pods -n dev -w</span></span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pc<span class="literal">-job-684ft</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">5</span>s</span><br><span class="line">pc<span class="literal">-job-jhj49</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">5</span>s</span><br><span class="line">pc<span class="literal">-job-pfcvh</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">5</span>s</span><br><span class="line">pc<span class="literal">-job-684ft</span>   <span class="number">0</span>/<span class="number">1</span>     Completed   <span class="number">0</span>          <span class="number">11</span>s</span><br><span class="line">pc<span class="literal">-job-v7rhr</span>   <span class="number">0</span>/<span class="number">1</span>     Pending     <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-job-v7rhr</span>   <span class="number">0</span>/<span class="number">1</span>     Pending     <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-job-v7rhr</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-job-jhj49</span>   <span class="number">0</span>/<span class="number">1</span>     Completed           <span class="number">0</span>          <span class="number">11</span>s</span><br><span class="line">pc<span class="literal">-job-fhwf7</span>   <span class="number">0</span>/<span class="number">1</span>     Pending             <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-job-fhwf7</span>   <span class="number">0</span>/<span class="number">1</span>     Pending             <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-job-pfcvh</span>   <span class="number">0</span>/<span class="number">1</span>     Completed           <span class="number">0</span>          <span class="number">11</span>s</span><br><span class="line">pc<span class="literal">-job-5vg2j</span>   <span class="number">0</span>/<span class="number">1</span>     Pending             <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-job-fhwf7</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-job-5vg2j</span>   <span class="number">0</span>/<span class="number">1</span>     Pending             <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-job-5vg2j</span>   <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">pc<span class="literal">-job-fhwf7</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">2</span>s</span><br><span class="line">pc<span class="literal">-job-v7rhr</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">2</span>s</span><br><span class="line">pc<span class="literal">-job-5vg2j</span>   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">3</span>s</span><br><span class="line">pc<span class="literal">-job-fhwf7</span>   <span class="number">0</span>/<span class="number">1</span>     Completed           <span class="number">0</span>          <span class="number">12</span>s</span><br><span class="line">pc<span class="literal">-job-v7rhr</span>   <span class="number">0</span>/<span class="number">1</span>     Completed           <span class="number">0</span>          <span class="number">12</span>s</span><br><span class="line">pc<span class="literal">-job-5vg2j</span>   <span class="number">0</span>/<span class="number">1</span>     Completed           <span class="number">0</span>          <span class="number">12</span>s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除job</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl delete -f pc-job.yaml</span></span><br><span class="line">job.batch <span class="string">&quot;pc-job&quot;</span> deleted</span><br></pre></td></tr></table></figure>

<h2 id="6-CronJob-CJ"><a href="#6-CronJob-CJ" class="headerlink" title="6. CronJob(CJ)"></a>6. CronJob(CJ)</h2><p>CronJob控制器以Job控制器资源为其管控对象，并借助它管理pod资源对象，Job控制器定义的作业任务在其控制器资源创建之后便会立即执行，但CronJob可以以类似于Linux操作系统的周期性任务作业计划的方式控制其运行<strong>时间点</strong>及<strong>重复运行</strong>的方式。也就是说，<strong>CronJob可以在特定的时间点(反复的)去运行job任务</strong>。</p>
<p><img src="https://img-blog.csdnimg.cn/2f5daffd251d4859b61b672b026768b8.png" alt="在这里插入图片描述"><br>CronJob的资源清单文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1beta1</span> <span class="comment"># 版本号</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span> <span class="comment"># 类型       </span></span><br><span class="line"><span class="attr">metadata:</span> <span class="comment"># 元数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="comment"># rs名称 </span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="comment"># 所属命名空间 </span></span><br><span class="line">  <span class="attr">labels:</span> <span class="comment">#标签</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="string">cronjob</span></span><br><span class="line"><span class="attr">spec:</span> <span class="comment"># 详情描述</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="comment"># cron格式的作业调度运行时间点,用于控制任务在什么时间执行</span></span><br><span class="line">  <span class="attr">concurrencyPolicy:</span> <span class="comment"># 并发执行策略，用于定义前一次作业运行尚未完成时是否以及如何运行后一次的作业</span></span><br><span class="line">  <span class="attr">failedJobHistoryLimit:</span> <span class="comment"># 为失败的任务执行保留的历史记录数，默认为1</span></span><br><span class="line">  <span class="attr">successfulJobHistoryLimit:</span> <span class="comment"># 为成功的任务执行保留的历史记录数，默认为3</span></span><br><span class="line">  <span class="attr">startingDeadlineSeconds:</span> <span class="comment"># 启动作业错误的超时时长</span></span><br><span class="line">  <span class="attr">jobTemplate:</span> <span class="comment"># job控制器模板，用于为cronjob控制器生成job对象;下面其实就是job的定义</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">completions:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">parallelism:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">activeDeadlineSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">backoffLimit:</span> <span class="number">6</span></span><br><span class="line">      <span class="attr">manualSelector:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">selector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">counter-pod</span></span><br><span class="line">        <span class="attr">matchExpressions:</span> <span class="string">规则</span></span><br><span class="line">          <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">app</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">counter-pod</span>]&#125;</span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">metadata:</span></span><br><span class="line">          <span class="attr">labels:</span></span><br><span class="line">            <span class="attr">app:</span> <span class="string">counter-pod</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">Never</span> </span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">counter</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br><span class="line">            <span class="attr">command:</span> [<span class="string">&quot;bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 20;done&quot;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">需要重点解释的几个选项：</span><br><span class="line">schedule: cron表达式，用于指定任务的执行时间</span><br><span class="line"><span class="code">	*/1    *      *    *     *</span></span><br><span class="line"><span class="code">	&lt;分钟&gt; &lt;小时&gt; &lt;日&gt; &lt;月份&gt; &lt;星期&gt;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    分钟 值从 0 到 59.</span></span><br><span class="line"><span class="code">    小时 值从 0 到 23.</span></span><br><span class="line"><span class="code">    日 值从 1 到 31.</span></span><br><span class="line"><span class="code">    月 值从 1 到 12.</span></span><br><span class="line"><span class="code">    星期 值从 0 到 6, 0 代表星期日</span></span><br><span class="line"><span class="code">    多个时间可以用逗号隔开； 范围可以用连字符给出；*可以作为通配符； /表示每...</span></span><br><span class="line"><span class="code">concurrencyPolicy:</span></span><br><span class="line"><span class="code">	Allow:   允许Jobs并发运行(默认)</span></span><br><span class="line"><span class="code">	Forbid:  禁止并发运行，如果上一次运行尚未完成，则跳过下一次运行</span></span><br><span class="line"><span class="code">	Replace: 替换，取消当前正在运行的作业并用新作业替换它</span></span><br></pre></td></tr></table></figure>

<p>创建<code>pc-cronjob.yaml</code>，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pc-cronjob</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="string">cronjob</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;*/1 * * * *&quot;</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">counter</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br><span class="line">            <span class="attr">command:</span> [<span class="string">&quot;bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&quot;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建cronjob</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl create -f pc-cronjob.yaml</span></span><br><span class="line">cronjob.batch/pc<span class="literal">-cronjob</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看cronjob</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get cronjobs -n dev</span></span><br><span class="line">NAME         SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</span><br><span class="line">pc<span class="literal">-cronjob</span>   */<span class="number">1</span> * * * *   False     <span class="number">0</span>        &lt;none&gt;          <span class="number">6</span>s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看job</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get jobs -n dev</span></span><br><span class="line">NAME                    COMPLETIONS   DURATION   AGE</span><br><span class="line">pc<span class="literal">-cronjob-1592587800</span>   <span class="number">1</span>/<span class="number">1</span>           <span class="number">28</span>s        <span class="number">3</span>m26s</span><br><span class="line">pc<span class="literal">-cronjob-1592587860</span>   <span class="number">1</span>/<span class="number">1</span>           <span class="number">28</span>s        <span class="number">2</span>m26s</span><br><span class="line">pc<span class="literal">-cronjob-1592587920</span>   <span class="number">1</span>/<span class="number">1</span>           <span class="number">28</span>s        <span class="number">86</span>s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl get pods -n dev</span></span><br><span class="line">pc<span class="literal">-cronjob-1592587800-x4tsm</span>   <span class="number">0</span>/<span class="number">1</span>     Completed   <span class="number">0</span>          <span class="number">2</span>m24s</span><br><span class="line">pc<span class="literal">-cronjob-1592587860-r5gv4</span>   <span class="number">0</span>/<span class="number">1</span>     Completed   <span class="number">0</span>          <span class="number">84</span>s</span><br><span class="line">pc<span class="literal">-cronjob-1592587920-9dxxq</span>   <span class="number">1</span>/<span class="number">1</span>     Running     <span class="number">0</span>          <span class="number">24</span>s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除cronjob</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># kubectl  delete -f pc-cronjob.yaml</span></span><br><span class="line">cronjob.batch <span class="string">&quot;pc-cronjob&quot;</span> deleted</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/11/02/kubernetes/7kubernetes%20Pod%E8%B0%83%E5%BA%A6/" rel="prev" title="kubernetes Pod调度">
      <i class="fa fa-chevron-left"></i> kubernetes Pod调度
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/11/02/kubernetes/9kubernetes%20Service%E8%AF%A6%E8%A7%A3/" rel="next" title="kubernetes Service详解">
      kubernetes Service详解 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-ReplicaSet-RS"><span class="nav-number">1.</span> <span class="nav-text">1. ReplicaSet(RS)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Deployment-Deploy"><span class="nav-number">2.</span> <span class="nav-text">2. Deployment(Deploy)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Horizontal-Pod-Autoscaler-HPA"><span class="nav-number">3.</span> <span class="nav-text">3. Horizontal Pod Autoscaler(HPA)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-DaemonSet-DS"><span class="nav-number">4.</span> <span class="nav-text">4. DaemonSet(DS)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Job"><span class="nav-number">5.</span> <span class="nav-text">5. Job</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-CronJob-CJ"><span class="nav-number">6.</span> <span class="nav-text">6. CronJob(CJ)</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Omlight"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Omlight</p>
  <div class="site-description" itemprop="description">gopher</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">142</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/omlight95" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;omlight95" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/qq_49723651?spm=1000.2115.3001.5343" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_49723651?spm&#x3D;1000.2115.3001.5343" rel="noopener" target="_blank"><i class="fa custom csdn fa-fw"></i>CSDN</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Omlight</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.5.1/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'NYxlvPYAXEonmQ80BtgDUD58-gzGzoHsz',
      appKey     : 'su4psizeZXLgtHkhviTz7tct',
      placeholder: "欢迎畅所欲言",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-Hans' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
